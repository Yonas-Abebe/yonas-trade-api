<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="process-trades-to-ods-subflow" doc:id="ec7da3be-aad0-4988-9724-4704b9377c30" >
		<logger level="INFO" doc:name="Logger" doc:id="3dfbe137-2958-45bc-8d37-46d8ad17229c" message='#["request received to process trade to ODs, correlationId: " ++ correlationId]'/>
		<choice doc:name="Choice" doc:id="9af3519b-7a08-411a-ba74-f601a29dd5fe" >
			<when expression='#[lower(payload."type")=="equity"]'>
				<logger level="INFO" doc:name="equity" doc:id="117bac0b-0a6f-412b-8029-2da11c381e88" message='#["received to process equity trade, correlationId: " ++ correlationId]'/>
				<ee:transform doc:name="set Vars" doc:id="38042b7c-2862-4f11-b162-51a3ed0c2434">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="sqlQuery"><![CDATA[%dw 2.0
output application/json
---
"insert into [dbo].[equity]
([index], symbol, operation, quantity, price) values
(:index, :symbol, :operation, :quantity, :price)"]]></ee:set-variable>
						<ee:set-variable variableName="sqlInputParams"><![CDATA[%dw 2.0
output application/json
---
{
	index: payload.index, 
	symbol: payload.symbol,
	operation: payload.operation,
    quantity: payload.quantity,
    price: payload.price
    
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="insert-to-db-subflow" doc:id="17afafee-1887-42f6-bdd9-652fe0cc3386" name="insert-to-db-subflow"/>
				<ee:transform doc:name="set response" doc:id="090ba210-aed9-417e-b3ec-5a2cf6dab976" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{

"status":"trade processed successfully"

}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[lower(payload."type")=="fx"]'>
				<logger level="INFO" doc:name="fx" doc:id="e339edca-2698-4ad0-879f-a8d7f1aaa7e8" message='#["received to process fx trade, correlationId: " ++ correlationId]'/>
				<ee:transform doc:name="set Vars" doc:id="fe418922-2a06-4503-8aff-71b0ac08ff7d" >
					<ee:message />
					<ee:variables >
						<ee:set-variable variableName="sqlQuery" ><![CDATA[%dw 2.0
output application/json
---
"insert into [dbo].[fx]
([index], symbol, operation, quantity, price) values
(:index, :symbol, :operation, :quantity, :price)"]]></ee:set-variable>
						<ee:set-variable variableName="sqlInputParams" ><![CDATA[%dw 2.0
output application/json
---
{
	index: payload.index, 
	symbol: payload.symbol,
	operation: payload.operation,
    quantity: payload.quantity,
    price: payload.price
    
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="insert-to-db-subflow" doc:id="ee65d22e-dda8-4f8b-b2bb-8c102745ce3d" name="insert-to-db-subflow" />
				<ee:transform doc:name="set response" doc:id="0502e079-bf8c-415f-941a-8122d07e6306" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{

"status":"trade processed successfully"

}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="485742da-2b05-4f8e-bbde-51eaf8885512" message='#["received invalid trade, correlationId: " ++ correlationId]'/>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="insert-to-db-subflow" doc:id="258df0d0-4de9-45fe-9458-dc6586bf3122" >
		<logger level="INFO" doc:name="Logger" doc:id="aeb43966-7302-4ff5-89ca-c561ef95cd4d" message="ready to insert into DB"/>
		<db:insert doc:name="Insert" doc:id="64aef0df-be70-4a1d-b015-1117e0f81eb4" config-ref="Database_Config">
			<db:sql ><![CDATA[#[vars.sqlQuery]]]></db:sql>
			<db:input-parameters ><![CDATA[#[vars.sqlInputParams]]]></db:input-parameters>
		</db:insert>
		<logger level="INFO" doc:name="Logger" doc:id="3110d192-7728-46b5-8ec0-45a3135aa89c" message="record inserted into DB"/>
	</sub-flow>
</mule>
